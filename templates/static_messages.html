{% extends "base.html" %}

{% block title %}Static Messages - Admin Panel{% endblock %}

{% block extra_css %}
<style>
.message-preview {
    min-height: 200px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 5px;
    word-wrap: break-word;
}
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-envelope"></i> Static Messages</h2>
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addMessageModal">
        <i class="bi bi-plus-circle"></i> Add Static Message
    </button>
</div>

<div class="alert alert-info">
    <i class="bi bi-info-circle"></i>
    <strong>Info:</strong> Static messages are automatically sent to users on specific days after they join.
    For example, a "Day 1" message will be sent to users one day after they join the channel.
    <br><br>
    <strong>Time Configuration:</strong>
    <ul class="mb-0 mt-2">
        <li><strong>Day 0:</strong> Messages are sent based on join time + additional minutes (no specific time needed)</li>
        <li><strong>Day 1+:</strong> Messages are sent at a specific UTC time (e.g., 12:05) + additional minutes</li>
        <li>Multiple messages can be scheduled for the same day with different times</li>
        <li>Additional minutes can be used to offset the send time (e.g., +5 min, +15 min)</li>
    </ul>
</div>

<!-- Static Messages Table -->
<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Day Number</th>
                        <th>Type</th>
                        <th>Message</th>
                        <th>Send Time</th>
                        <th>Buttons</th>
                        <th>Status</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for msg in messages %}
                    <tr>
                        <td>
                            <span class="badge bg-primary">Day {{ msg.day_number }}</span>
                        </td>
                        <td>
                            <span class="badge bg-info">{{ msg.media_type or 'text' }}</span>
                            {% if msg.media_file_id %}
                            <br>
                            <small class="text-muted" style="font-size: 0.7rem;" title="{{ msg.media_file_id }}">
                                ID: {{ msg.media_file_id[:15] }}...
                            </small>
                            {% endif %}
                        </td>
                        <td>
                            <div style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">
                                {{ msg.text[:80] }}{% if msg.text|length > 80 %}...{% endif %}
                            </div>
                        </td>
                        <td>
                            {% if msg.send_time %}
                            <span class="badge bg-secondary">{{ msg.send_time }}</span>
                            {% else %}
                            <span class="badge bg-light text-dark">{% if msg.day_number == 0 %}From Join{% else %}09:00{% endif %}</span>
                            {% endif %}
                            {% if msg.additional_minutes and msg.additional_minutes > 0 %}
                            <span class="badge bg-warning text-dark">+{{ msg.additional_minutes }}m</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if msg.buttons_config %}
                            <i class="bi bi-link-45deg text-success" title="Has buttons"></i>
                            {% else %}
                            <i class="bi bi-dash text-muted"></i>
                            {% endif %}
                        </td>
                        <td>
                            {% if msg.is_active %}
                            <span class="badge bg-success">Active</span>
                            {% else %}
                            <span class="badge bg-secondary">Inactive</span>
                            {% endif %}
                        </td>
                        <td>{{ msg.created_at[:10] }}</td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick='editMessage({{ msg | tojson }})'>
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-info" onclick="toggleMessage({{ msg.id }})">
                                <i class="bi bi-toggle-on"></i>
                            </button>
                            <button class="btn btn-sm btn-success" onclick="showSendTestModal({{ msg.id }})">
                                <i class="bi bi-send"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteMessage({{ msg.id }})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Message Modal -->
<div class="modal fade" id="addMessageModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Static Message</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Message Configuration</h6>
                        <div class="mb-3">
                            <label class="form-label">Day Number</label>
                            <input type="number" class="form-control" id="addDayNumber" min="0" required onchange="handleDayNumberChange('add')">
                            <small class="text-muted">Day 0 = immediately after join, Day 1 = 1 day after, etc.</small>
                        </div>
                        
                        <div class="mb-3" id="addSendTimeDiv" style="display: none;">
                            <label class="form-label">Send Time (UTC)</label>
                            <input type="time" class="form-control" id="addSendTime" placeholder="HH:MM">
                            <small class="text-muted">Time in UTC when to send (for Day 1+). Leave empty for 09:00 default.</small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Additional Minutes (Optional)</label>
                            <input type="number" class="form-control" id="addAdditionalMinutes" min="0" value="0">
                            <small class="text-muted">Offset in minutes to add to send time (e.g., 5, 15, 30)</small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Media Type</label>
                            <select class="form-select" id="addMediaType" onchange="handleMediaTypeChange('add')">
                                <option value="text">Text Only</option>
                                <option value="photo">Photo + Text</option>
                                <option value="video">Video + Text</option>
                                <option value="video_note">Round Video (Video Note)</option>
                                <option value="animation">GIF/Animation + Text</option>
                                <option value="document">Document + Text</option>
                                <option value="audio">Audio + Text</option>
                                <option value="voice">Voice + Text</option>
                            </select>
                        </div>
                        
                        <div class="mb-3" id="addMediaUpload" style="display: none;">
                            <label class="form-label">Media File</label>
                            
                            <!-- Option 1: Upload File -->
                            <div class="card mb-2">
                                <div class="card-body">
                                    <h6 class="card-subtitle mb-2 text-muted">Option 1: Upload File</h6>
                                    <input type="file" class="form-control mb-2" id="addMediaFile" accept="image/*,video/*,audio/*">
                                    <button type="button" class="btn btn-sm btn-secondary" onclick="uploadMedia('add')">
                                        <i class="bi bi-upload"></i> Upload
                                    </button>
                                    <div id="addUploadStatus" class="mt-2"></div>
                                </div>
                            </div>
                            
                            <!-- Option 2: Enter File ID Manually -->
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-subtitle mb-2 text-muted">Option 2: Enter File ID Manually</h6>
                                    <small class="text-muted d-block mb-2">Get file_id from messages in your admin chat or from previously uploaded files</small>
                                    <input type="text" class="form-control" id="addMediaFileId" placeholder="Paste file_id here (e.g., AgACAgIAAxkBAAI...)">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Message Text</label>
                            <textarea class="form-control" id="addText" rows="4"></textarea>
                            <small class="text-muted">Plain text for fallback (optional if HTML text is provided)</small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">HTML Text (Optional)</label>
                            <textarea class="form-control" id="addHtml" rows="4" oninput="updatePreview('add')"></textarea>
                            <small class="text-muted">Use HTML formatting: &lt;b&gt;bold&lt;/b&gt;, &lt;i&gt;italic&lt;/i&gt;, &lt;a href="url"&gt;link&lt;/a&gt;</small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Buttons Configuration (Optional)</label>
                            <textarea class="form-control" id="addButtons" rows="3" placeholder="Button 1 | https://url1.com, Button 2 | https://url2.com&#10;Button 3 | https://url3.com"></textarea>
                            <small class="text-muted">Format: text | url, text2 | url2 (one row per line, comma for columns)</small>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <h6>Live Preview</h6>
                        <div class="card">
                            <div class="card-body">
                                <div id="addPreview" class="message-preview">
                                    <em class="text-muted">Type HTML text to see preview...</em>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addMessage()">
                    <i class="bi bi-plus-circle"></i> Add Message
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Message Modal -->
<div class="modal fade" id="editMessageModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Static Message</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editMessageId">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Message Configuration</h6>
                        <div class="mb-3">
                            <label class="form-label">Day Number</label>
                            <input type="number" class="form-control" id="editDayNumber" min="0" required onchange="handleDayNumberChange('edit')">
                        </div>
                        
                        <div class="mb-3" id="editSendTimeDiv" style="display: none;">
                            <label class="form-label">Send Time (UTC)</label>
                            <input type="time" class="form-control" id="editSendTime" placeholder="HH:MM">
                            <small class="text-muted">Time in UTC when to send (for Day 1+). Leave empty for 09:00 default.</small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Additional Minutes (Optional)</label>
                            <input type="number" class="form-control" id="editAdditionalMinutes" min="0" value="0">
                            <small class="text-muted">Offset in minutes to add to send time (e.g., 5, 15, 30)</small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Media Type</label>
                            <select class="form-select" id="editMediaType" onchange="handleMediaTypeChange('edit')">
                                <option value="text">Text Only</option>
                                <option value="photo">Photo + Text</option>
                                <option value="video">Video + Text</option>
                                <option value="video_note">Round Video (Video Note)</option>
                                <option value="animation">GIF/Animation + Text</option>
                                <option value="document">Document + Text</option>
                                <option value="audio">Audio + Text</option>
                                <option value="voice">Voice + Text</option>
                            </select>
                        </div>
                        
                        <div class="mb-3" id="editMediaUpload">
                            <label class="form-label">Media File</label>
                            
                            <!-- Current File ID Display -->
                            <div class="card mb-2 bg-light" id="editCurrentFileId" style="display: none;">
                                <div class="card-body py-2">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <small class="text-muted">Current File ID:</small>
                                            <code class="ms-2" id="editCurrentFileIdText"></code>
                                        </div>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="copyToClipboard('editCurrentFileIdText')">
                                            <i class="bi bi-clipboard"></i> Copy
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Option 1: Upload New File -->
                            <div class="card mb-2">
                                <div class="card-body">
                                    <h6 class="card-subtitle mb-2 text-muted">Option 1: Upload New File</h6>
                                    <input type="file" class="form-control mb-2" id="editMediaFile" accept="image/*,video/*,audio/*">
                                    <button type="button" class="btn btn-sm btn-secondary" onclick="uploadMedia('edit')">
                                        <i class="bi bi-upload"></i> Upload
                                    </button>
                                    <small class="text-muted d-block mt-1">This will replace the current file</small>
                                    <div id="editUploadStatus" class="mt-2"></div>
                                </div>
                            </div>
                            
                            <!-- Option 2: Change File ID Manually -->
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-subtitle mb-2 text-muted">Option 2: Change File ID Manually</h6>
                                    <small class="text-muted d-block mb-2">Get file_id from messages in your admin chat or from previously uploaded files</small>
                                    <input type="text" class="form-control" id="editMediaFileId" placeholder="Paste file_id here (e.g., AgACAgIAAxkBAAI...)">
                                    <button type="button" class="btn btn-sm btn-outline-danger mt-2" onclick="clearMediaFileId('edit')">
                                        <i class="bi bi-x-circle"></i> Clear Media
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Message Text</label>
                            <textarea class="form-control" id="editText" rows="4"></textarea>
                            <small class="text-muted">Plain text for fallback (optional if HTML text is provided)</small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">HTML Text (Optional)</label>
                            <textarea class="form-control" id="editHtml" rows="4" oninput="updatePreview('edit')"></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Buttons Configuration (Optional)</label>
                            <textarea class="form-control" id="editButtons" rows="3" placeholder="Button 1 | https://url1.com, Button 2 | https://url2.com&#10;Button 3 | https://url3.com"></textarea>
                            <small class="text-muted">Format: text | url, text2 | url2 (one row per line, comma for columns)</small>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <h6>Live Preview</h6>
                        <div class="card">
                            <div class="card-body">
                                <div id="editPreview" class="message-preview">
                                    <em class="text-muted">Type HTML text to see preview...</em>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateMessage()">
                    <i class="bi bi-save"></i> Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Send Test Modal -->
<div class="modal fade" id="sendTestModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Send Test Message</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="testMessageId">
                <div class="mb-3">
                    <label class="form-label">User ID or Username</label>
                    <input type="text" class="form-control" id="testTarget" placeholder="12345678 or @username or username">
                    <small class="text-muted">Enter a numeric Telegram user ID or username (with or without @)</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="sendTestMessage()">
                    <i class="bi bi-send"></i> Send Test
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function sanitizeHTML(html) {
    // Create a temporary div to parse HTML
    const temp = document.createElement('div');
    temp.textContent = html; // This escapes all HTML
    const escaped = temp.innerHTML;
    
    // Now only allow specific Telegram HTML tags
    // Telegram supports: b, i, u, s, code, pre, a, tg-spoiler, tg-emoji
    const allowedTags = {
        '&lt;b&gt;': '<b>',
        '&lt;/b&gt;': '</b>',
        '&lt;i&gt;': '<i>',
        '&lt;/i&gt;': '</i>',
        '&lt;u&gt;': '<u>',
        '&lt;/u&gt;': '</u>',
        '&lt;s&gt;': '<s>',
        '&lt;/s&gt;': '</s>',
        '&lt;code&gt;': '<code>',
        '&lt;/code&gt;': '</code>',
        '&lt;pre&gt;': '<pre>',
        '&lt;/pre&gt;': '</pre>',
        '&lt;br&gt;': '<br>',
        '&lt;br/&gt;': '<br>',
        '&lt;br /&gt;': '<br>'
    };
    
    let result = escaped;
    for (const [escaped_tag, real_tag] of Object.entries(allowedTags)) {
        result = result.replaceAll(escaped_tag, real_tag);
    }
    
    // Handle links with href attribute (more complex parsing)
    // Match pattern: &lt;a href="..."&gt;...&lt;/a&gt;
    result = result.replace(/&lt;a href=&quot;([^&"]+)&quot;&gt;([^<]+)&lt;\/a&gt;/g, 
        '<a href="$1" target="_blank" rel="noopener noreferrer">$2</a>');
    
    return result;
}

function updatePreview(mode) {
    const htmlText = document.getElementById(`${mode}Html`).value;
    const previewDiv = document.getElementById(`${mode}Preview`);
    
    if (htmlText.trim()) {
        // Sanitize and render HTML
        const sanitized = sanitizeHTML(htmlText);
        previewDiv.innerHTML = sanitized;
    } else {
        previewDiv.innerHTML = '<em class="text-muted">Type HTML text to see preview...</em>';
    }
}

function handleMediaTypeChange(mode) {
    const mediaType = document.getElementById(`${mode}MediaType`).value;
    const uploadDiv = document.getElementById(`${mode}MediaUpload`);
    
    if (mediaType !== 'text') {
        uploadDiv.style.display = 'block';
    } else {
        uploadDiv.style.display = 'none';
    }
}

function handleDayNumberChange(mode) {
    const dayNumber = document.getElementById(`${mode}DayNumber`).value;
    const sendTimeDiv = document.getElementById(`${mode}SendTimeDiv`);
    
    if (parseInt(dayNumber) === 0) {
        sendTimeDiv.style.display = 'none';
    } else {
        sendTimeDiv.style.display = 'block';
    }
}

async function uploadMedia(mode) {
    const fileInput = document.getElementById(`${mode}MediaFile`);
    const mediaType = document.getElementById(`${mode}MediaType`).value;
    const statusDiv = document.getElementById(`${mode}UploadStatus`);
    
    if (!fileInput.files || !fileInput.files[0]) {
        statusDiv.innerHTML = '<span class="text-danger">Please select a file</span>';
        return;
    }
    
    statusDiv.innerHTML = '<span class="text-info"><i class="bi bi-hourglass-split"></i> Uploading...</span>';
    
    try {
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        formData.append('media_type', mediaType);
        
        const response = await fetch('/api/static-messages/upload-media', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (response.ok && data.file_id) {
            document.getElementById(`${mode}MediaFileId`).value = data.file_id;
            statusDiv.innerHTML = `<span class="text-success"><i class="bi bi-check-circle"></i> Uploaded! File ID: ${data.file_id.substring(0, 20)}...</span>`;
        } else {
            statusDiv.innerHTML = `<span class="text-danger"><i class="bi bi-x-circle"></i> ${data.detail || 'Upload failed'}</span>`;
        }
    } catch (error) {
        statusDiv.innerHTML = `<span class="text-danger"><i class="bi bi-x-circle"></i> Error: ${error.message}</span>`;
    }
}

async function addMessage() {
    const dayNumber = document.getElementById('addDayNumber').value;
    const text = document.getElementById('addText').value.trim();
    const htmlText = document.getElementById('addHtml').value.trim();
    const mediaType = document.getElementById('addMediaType').value;
    const mediaFileId = document.getElementById('addMediaFileId').value;
    const buttonsConfig = document.getElementById('addButtons').value.trim();
    const sendTime = document.getElementById('addSendTime').value;
    const additionalMinutes = document.getElementById('addAdditionalMinutes').value || 0;
    
    if (!dayNumber) {
        showNotification('Please enter day number', 'error');
        return;
    }
    
    if (!text && !htmlText) {
        showNotification('Please enter either message text or HTML text', 'error');
        return;
    }
    
    if (mediaType !== 'text' && !mediaFileId) {
        showNotification('Please upload a media file or change media type to "Text Only"', 'error');
        return;
    }
    
    try {
        const response = await fetch('/api/static-messages/add', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                day_number: parseInt(dayNumber),
                text: text || htmlText,
                html_text: htmlText,
                media_type: mediaType,
                media_file_id: mediaFileId,
                buttons_config: buttonsConfig,
                send_time: sendTime || null,
                additional_minutes: parseInt(additionalMinutes)
            })
        });
        const data = await response.json();
        showNotification(data.message, 'success');
        setTimeout(() => location.reload(), 1000);
    } catch (error) {
        showNotification('Error: ' + error, 'error');
    }
}

function editMessage(msg) {
    document.getElementById('editMessageId').value = msg.id;
    document.getElementById('editDayNumber').value = msg.day_number;
    document.getElementById('editText').value = msg.text || '';
    document.getElementById('editHtml').value = msg.html_text || '';
    document.getElementById('editMediaType').value = msg.media_type || 'text';
    document.getElementById('editMediaFileId').value = msg.media_file_id || '';
    document.getElementById('editButtons').value = msg.buttons_config || '';
    document.getElementById('editSendTime').value = msg.send_time || '';
    document.getElementById('editAdditionalMinutes').value = msg.additional_minutes || 0;
    
    // Show current file_id if exists
    const currentFileIdDiv = document.getElementById('editCurrentFileId');
    const currentFileIdText = document.getElementById('editCurrentFileIdText');
    if (msg.media_file_id) {
        currentFileIdText.textContent = msg.media_file_id;
        currentFileIdDiv.style.display = 'block';
    } else {
        currentFileIdDiv.style.display = 'none';
    }
    
    handleMediaTypeChange('edit');
    handleDayNumberChange('edit');
    updatePreview('edit');
    
    const modal = new bootstrap.Modal(document.getElementById('editMessageModal'));
    modal.show();
}

async function updateMessage() {
    const id = document.getElementById('editMessageId').value;
    const dayNumber = document.getElementById('editDayNumber').value;
    const text = document.getElementById('editText').value.trim();
    const htmlText = document.getElementById('editHtml').value.trim();
    const mediaType = document.getElementById('editMediaType').value;
    const mediaFileId = document.getElementById('editMediaFileId').value;
    const buttonsConfig = document.getElementById('editButtons').value.trim();
    const sendTime = document.getElementById('editSendTime').value;
    const additionalMinutes = document.getElementById('editAdditionalMinutes').value || 0;
    
    if (!text && !htmlText) {
        showNotification('Please enter either message text or HTML text', 'error');
        return;
    }
    
    if (mediaType !== 'text' && !mediaFileId) {
        showNotification('Please upload a media file or change media type to "Text Only"', 'error');
        return;
    }
    
    try {
        const response = await fetch(`/api/static-messages/${id}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                day_number: parseInt(dayNumber),
                text: text || htmlText,
                html_text: htmlText,
                media_type: mediaType,
                media_file_id: mediaFileId,
                buttons_config: buttonsConfig,
                send_time: sendTime || null,
                additional_minutes: parseInt(additionalMinutes)
            })
        });
        const data = await response.json();
        showNotification(data.message, 'success');
        setTimeout(() => location.reload(), 1000);
    } catch (error) {
        showNotification('Error: ' + error, 'error');
    }
}

async function toggleMessage(id) {
    try {
        const response = await fetch(`/api/static-messages/${id}/toggle`, {
            method: 'POST'
        });
        const data = await response.json();
        showNotification(data.message, 'success');
        setTimeout(() => location.reload(), 1000);
    } catch (error) {
        showNotification('Error: ' + error, 'error');
    }
}

async function deleteMessage(id) {
    if (!confirm('Delete this static message?')) return;
    
    try {
        const response = await fetch(`/api/static-messages/${id}`, {
            method: 'DELETE'
        });
        const data = await response.json();
        showNotification(data.message, 'success');
        setTimeout(() => location.reload(), 1000);
    } catch (error) {
        showNotification('Error: ' + error, 'error');
    }
}

function showSendTestModal(messageId) {
    document.getElementById('testMessageId').value = messageId;
    document.getElementById('testTarget').value = '';
    const modal = new bootstrap.Modal(document.getElementById('sendTestModal'));
    modal.show();
}

async function sendTestMessage() {
    const messageId = document.getElementById('testMessageId').value;
    const target = document.getElementById('testTarget').value.trim();
    
    if (!target) {
        showNotification('Please enter a user ID or username', 'error');
        return;
    }
    
    try {
        const response = await fetch(`/api/static-messages/${messageId}/send-test`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ target: target })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showNotification(data.message, 'success');
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('sendTestModal'));
            if (modal) {
                modal.hide();
            }
        } else {
            showNotification(data.detail || 'Failed to send test message', 'error');
        }
    } catch (error) {
        showNotification('Error: ' + error, 'error');
    }
}

function copyToClipboard(elementId) {
    const element = document.getElementById(elementId);
    const text = element.textContent;
    
    navigator.clipboard.writeText(text).then(() => {
        showNotification('File ID copied to clipboard!', 'success');
    }).catch(err => {
        showNotification('Failed to copy: ' + err, 'error');
    });
}

function clearMediaFileId(mode) {
    if (!confirm('Are you sure you want to clear the media file? This will also change the media type to "Text Only".')) {
        return;
    }
    
    document.getElementById(`${mode}MediaFileId`).value = '';
    document.getElementById(`${mode}MediaType`).value = 'text';
    handleMediaTypeChange(mode);
    showNotification('Media cleared and type changed to "Text Only". Save to apply changes.', 'info');
}
</script>
{% endblock %}
