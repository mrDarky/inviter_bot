{% extends "base.html" %}

{% block title %}Menu Constructor - Admin Panel{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-menu-button-wide"></i> Bot Main Menu Constructor</h2>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addMenuItemModal">
        <i class="bi bi-plus-circle"></i> Add Button
    </button>
</div>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Order</th>
                        <th>Button Name</th>
                        <th>Type</th>
                        <th>Action</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="menuItemsTable">
                    {% for item in menu_items %}
                    <tr data-id="{{ item.id }}">
                        <td>{{ item.button_order }}</td>
                        <td><strong>{{ item.button_name }}</strong></td>
                        <td>
                            <span class="badge bg-info">{{ item.button_type }}</span>
                        </td>
                        <td>
                            {% if item.button_type == 'link' %}
                                <a href="{{ item.action_value }}" target="_blank" class="text-truncate d-inline-block" style="max-width: 200px;">
                                    {{ item.action_value }}
                                </a>
                            {% elif item.button_type == 'text' %}
                                <span class="text-muted">Show text message</span>
                            {% elif item.button_type == 'inline' %}
                                <span class="text-muted">Show inline buttons</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if item.is_active %}
                                <span class="badge bg-success">Active</span>
                            {% else %}
                                <span class="badge bg-secondary">Inactive</span>
                            {% endif %}
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="editMenuItem({{ item.id }})">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-warning" onclick="toggleMenuItem({{ item.id }})">
                                <i class="bi bi-toggle-on"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteMenuItem({{ item.id }})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        {% if not menu_items %}
        <div class="alert alert-info text-center">
            <i class="bi bi-info-circle"></i> No menu items yet. Click "Add Button" to create your first menu item.
        </div>
        {% endif %}
    </div>
</div>

<!-- Add Menu Item Modal -->
<div class="modal fade" id="addMenuItemModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Menu Button</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addMenuItemForm">
                    <div class="mb-3">
                        <label class="form-label">Button Name</label>
                        <input type="text" class="form-control" name="button_name" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Button Order</label>
                        <input type="number" class="form-control" name="button_order" min="1" value="{{ menu_items|length + 1 }}" required>
                        <small class="text-muted">Position in menu (lower numbers appear first)</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Button Type</label>
                        <select class="form-select" name="button_type" id="addButtonType" required>
                            <option value="link">Link - Navigate to URL</option>
                            <option value="text">Text - Show text message</option>
                            <option value="inline">Inline Buttons - Show inline keyboard</option>
                        </select>
                    </div>
                    
                    <div class="mb-3" id="addLinkField">
                        <label class="form-label">URL</label>
                        <input type="url" class="form-control" name="action_value" placeholder="https://example.com">
                    </div>
                    
                    <div class="mb-3" id="addTextField" style="display: none;">
                        <label class="form-label">Text Message</label>
                        <textarea class="form-control" name="action_value" rows="3" placeholder="Enter text to show"></textarea>
                    </div>
                    
                    <div class="mb-3" id="addInlineField" style="display: none;">
                        <label class="form-label">Inline Buttons (JSON format)</label>
                        <textarea class="form-control" name="inline_buttons" rows="5" placeholder='[{"text": "Button 1", "url": "https://example.com"}]'></textarea>
                        <small class="text-muted">Example: [{"text": "Visit", "url": "https://example.com"}]</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitAddMenuItem()">Add Button</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Menu Item Modal -->
<div class="modal fade" id="editMenuItemModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Menu Button</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editMenuItemForm">
                    <input type="hidden" name="menu_id" id="editMenuId">
                    
                    <div class="mb-3">
                        <label class="form-label">Button Name</label>
                        <input type="text" class="form-control" name="button_name" id="editButtonName" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Button Order</label>
                        <input type="number" class="form-control" name="button_order" id="editButtonOrder" min="1" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Button Type</label>
                        <select class="form-select" name="button_type" id="editButtonType" required>
                            <option value="link">Link - Navigate to URL</option>
                            <option value="text">Text - Show text message</option>
                            <option value="inline">Inline Buttons - Show inline keyboard</option>
                        </select>
                    </div>
                    
                    <div class="mb-3" id="editLinkField">
                        <label class="form-label">URL</label>
                        <input type="url" class="form-control" name="action_value" id="editActionValue" placeholder="https://example.com">
                    </div>
                    
                    <div class="mb-3" id="editTextField" style="display: none;">
                        <label class="form-label">Text Message</label>
                        <textarea class="form-control" name="action_value" id="editActionText" rows="3"></textarea>
                    </div>
                    
                    <div class="mb-3" id="editInlineField" style="display: none;">
                        <label class="form-label">Inline Buttons (JSON format)</label>
                        <textarea class="form-control" name="inline_buttons" id="editInlineButtons" rows="5"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitEditMenuItem()">Save Changes</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Handle button type change for add modal
document.getElementById('addButtonType').addEventListener('change', function() {
    const type = this.value;
    document.getElementById('addLinkField').style.display = type === 'link' ? 'block' : 'none';
    document.getElementById('addTextField').style.display = type === 'text' ? 'block' : 'none';
    document.getElementById('addInlineField').style.display = type === 'inline' ? 'block' : 'none';
});

// Handle button type change for edit modal
document.getElementById('editButtonType').addEventListener('change', function() {
    const type = this.value;
    document.getElementById('editLinkField').style.display = type === 'link' ? 'block' : 'none';
    document.getElementById('editTextField').style.display = type === 'text' ? 'block' : 'none';
    document.getElementById('editInlineField').style.display = type === 'inline' ? 'block' : 'none';
});

// Submit add menu item
async function submitAddMenuItem() {
    const form = document.getElementById('addMenuItemForm');
    const formData = new FormData(form);
    
    const menuItem = {
        button_name: formData.get('button_name'),
        button_order: parseInt(formData.get('button_order')),
        button_type: formData.get('button_type'),
        action_value: formData.get('action_value'),
        inline_buttons: formData.get('inline_buttons')
    };
    
    try {
        const response = await fetch('/api/menu', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(menuItem)
        });
        const data = await response.json();
        
        if (response.ok) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + (data.detail || data.message));
        }
    } catch (error) {
        alert('Error: ' + error);
    }
}

// Edit menu item
async function editMenuItem(menuId) {
    try {
        const response = await fetch('/api/menu');
        const data = await response.json();
        const item = data.menu_items.find(i => i.id === menuId);
        
        if (!item) {
            alert('Menu item not found');
            return;
        }
        
        document.getElementById('editMenuId').value = item.id;
        document.getElementById('editButtonName').value = item.button_name;
        document.getElementById('editButtonOrder').value = item.button_order;
        document.getElementById('editButtonType').value = item.button_type;
        
        // Show appropriate field
        document.getElementById('editLinkField').style.display = 'none';
        document.getElementById('editTextField').style.display = 'none';
        document.getElementById('editInlineField').style.display = 'none';
        
        if (item.button_type === 'link') {
            document.getElementById('editLinkField').style.display = 'block';
            document.getElementById('editActionValue').value = item.action_value || '';
        } else if (item.button_type === 'text') {
            document.getElementById('editTextField').style.display = 'block';
            document.getElementById('editActionText').value = item.action_value || '';
        } else if (item.button_type === 'inline') {
            document.getElementById('editInlineField').style.display = 'block';
            document.getElementById('editInlineButtons').value = item.inline_buttons || '';
        }
        
        new bootstrap.Modal(document.getElementById('editMenuItemModal')).show();
    } catch (error) {
        alert('Error: ' + error);
    }
}

// Submit edit menu item
async function submitEditMenuItem() {
    const form = document.getElementById('editMenuItemForm');
    const formData = new FormData(form);
    const menuId = formData.get('menu_id');
    
    const buttonType = formData.get('button_type');
    let actionValue = null;
    let inlineButtons = null;
    
    if (buttonType === 'link') {
        actionValue = document.getElementById('editActionValue').value;
    } else if (buttonType === 'text') {
        actionValue = document.getElementById('editActionText').value;
    } else if (buttonType === 'inline') {
        inlineButtons = document.getElementById('editInlineButtons').value;
    }
    
    const menuItem = {
        button_name: formData.get('button_name'),
        button_order: parseInt(formData.get('button_order')),
        button_type: buttonType,
        action_value: actionValue,
        inline_buttons: inlineButtons
    };
    
    try {
        const response = await fetch(`/api/menu/${menuId}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(menuItem)
        });
        const data = await response.json();
        
        if (response.ok) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + (data.detail || data.message));
        }
    } catch (error) {
        alert('Error: ' + error);
    }
}

// Toggle menu item
async function toggleMenuItem(menuId) {
    try {
        const response = await fetch(`/api/menu/${menuId}/toggle`, {
            method: 'POST'
        });
        const data = await response.json();
        
        if (response.ok) {
            location.reload();
        } else {
            alert('Error: ' + (data.detail || data.message));
        }
    } catch (error) {
        alert('Error: ' + error);
    }
}

// Delete menu item
async function deleteMenuItem(menuId) {
    if (!confirm('Are you sure you want to delete this menu item?')) return;
    
    try {
        const response = await fetch(`/api/menu/${menuId}`, {
            method: 'DELETE'
        });
        const data = await response.json();
        
        if (response.ok) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + (data.detail || data.message));
        }
    } catch (error) {
        alert('Error: ' + error);
    }
}
</script>
{% endblock %}
