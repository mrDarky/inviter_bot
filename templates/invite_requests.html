{% extends "base.html" %}

{% block title %}Invite Requests - Admin Panel{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-person-plus"></i> Invite Requests</h2>
</div>

<!-- Filter -->
<div class="card mb-3">
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-6">
                <select class="form-select" name="status">
                    <option value="pending" {% if status == 'pending' %}selected{% endif %}>Pending</option>
                    <option value="approved" {% if status == 'approved' %}selected{% endif %}>Approved</option>
                    <option value="denied" {% if status == 'denied' %}selected{% endif %}>Denied</option>
                </select>
            </div>
            <div class="col-md-6">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-search"></i> Filter
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Actions Bar (Only for pending requests) -->
{% if status == 'pending' %}
<div class="card mb-3">
    <div class="card-body">
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-primary" onclick="selectAll()">
                <i class="bi bi-check-square"></i> Select All
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="deselectAll()">
                <i class="bi bi-square"></i> Deselect All
            </button>
        </div>
        <div class="btn-group ms-2" role="group">
            <button type="button" class="btn btn-success" onclick="approveSelected()">
                <i class="bi bi-check-circle"></i> Approve Selected
            </button>
            <button type="button" class="btn btn-danger" onclick="denySelected()">
                <i class="bi bi-x-circle"></i> Deny Selected
            </button>
        </div>
        <div class="btn-group ms-2" role="group">
            <button type="button" class="btn btn-success" onclick="approveAll()">
                <i class="bi bi-check-circle-fill"></i> Approve All
            </button>
            <button type="button" class="btn btn-danger" onclick="denyAll()">
                <i class="bi bi-x-circle-fill"></i> Deny All
            </button>
        </div>
    </div>
</div>
{% endif %}

<!-- Requests Table -->
<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        {% if status == 'pending' %}
                        <th width="50">
                            <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()">
                        </th>
                        {% endif %}
                        <th>User</th>
                        <th>Username</th>
                        <th>User ID</th>
                        <th>Chat ID</th>
                        <th>Request Date</th>
                        {% if status != 'pending' %}
                        <th>Processed Date</th>
                        {% endif %}
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for req in requests %}
                    <tr>
                        {% if status == 'pending' %}
                        <td>
                            <input type="checkbox" class="request-checkbox" value="{{ req.id }}">
                        </td>
                        {% endif %}
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="user-avatar me-2">
                                    {{ req.first_name[0] if req.first_name else 'U' }}
                                </div>
                                <div>
                                    <strong>{{ req.first_name or 'Unknown' }} {{ req.last_name or '' }}</strong>
                                </div>
                            </div>
                        </td>
                        <td>{{ '@' + req.username if req.username else '-' }}</td>
                        <td><code>{{ req.user_id }}</code></td>
                        <td><code>{{ req.chat_id }}</code></td>
                        <td>{{ req.request_date[:19].replace('T', ' ') if req.request_date else '-' }}</td>
                        {% if status != 'pending' %}
                        <td>{{ req.processed_date[:19].replace('T', ' ') if req.processed_date else '-' }}</td>
                        {% endif %}
                        <td>
                            {% if req.status == 'pending' %}
                            <span class="badge bg-warning">Pending</span>
                            {% elif req.status == 'approved' %}
                            <span class="badge bg-success">Approved</span>
                            {% elif req.status == 'denied' %}
                            <span class="badge bg-danger">Denied</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        {% if total_pages > 1 %}
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center">
                {% if page > 1 %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page - 1 }}{% if status %}&status={{ status }}{% endif %}">Previous</a>
                </li>
                {% endif %}
                
                {% for p in range(1, total_pages + 1) %}
                {% if p == page %}
                <li class="page-item active"><span class="page-link">{{ p }}</span></li>
                {% elif p <= 3 or p > total_pages - 3 or (p >= page - 1 and p <= page + 1) %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ p }}{% if status %}&status={{ status }}{% endif %}">{{ p }}</a>
                </li>
                {% elif p == 4 or p == total_pages - 3 %}
                <li class="page-item disabled"><span class="page-link">...</span></li>
                {% endif %}
                {% endfor %}
                
                {% if page < total_pages %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page + 1 }}{% if status %}&status={{ status }}{% endif %}">Next</a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function getSelectedRequestIds() {
    const checkboxes = document.querySelectorAll('.request-checkbox:checked');
    return Array.from(checkboxes).map(cb => parseInt(cb.value));
}

function selectAll() {
    document.querySelectorAll('.request-checkbox').forEach(cb => cb.checked = true);
    document.getElementById('selectAllCheckbox').checked = true;
}

function deselectAll() {
    document.querySelectorAll('.request-checkbox').forEach(cb => cb.checked = false);
    document.getElementById('selectAllCheckbox').checked = false;
}

function toggleSelectAll() {
    const checked = document.getElementById('selectAllCheckbox').checked;
    document.querySelectorAll('.request-checkbox').forEach(cb => cb.checked = checked);
}

async function approveSelected() {
    const requestIds = getSelectedRequestIds();
    if (requestIds.length === 0) {
        showNotification('Please select at least one request', 'error');
        return;
    }
    
    if (!confirm(`Approve ${requestIds.length} request(s)?`)) return;
    
    try {
        const response = await fetch('/api/invite-requests/approve', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(requestIds)
        });
        const data = await response.json();
        showNotification(data.message, 'success');
        setTimeout(() => location.reload(), 1000);
    } catch (error) {
        showNotification('Error: ' + error, 'error');
    }
}

async function denySelected() {
    const requestIds = getSelectedRequestIds();
    if (requestIds.length === 0) {
        showNotification('Please select at least one request', 'error');
        return;
    }
    
    if (!confirm(`Deny ${requestIds.length} request(s)?`)) return;
    
    try {
        const response = await fetch('/api/invite-requests/deny', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(requestIds)
        });
        const data = await response.json();
        showNotification(data.message, 'success');
        setTimeout(() => location.reload(), 1000);
    } catch (error) {
        showNotification('Error: ' + error, 'error');
    }
}

async function approveAll() {
    if (!confirm('Approve all pending requests? This action will process all pending join requests.')) return;
    
    try {
        const response = await fetch('/api/invite-requests/approve-all', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        const data = await response.json();
        showNotification(data.message, 'success');
        setTimeout(() => location.reload(), 1000);
    } catch (error) {
        showNotification('Error: ' + error, 'error');
    }
}

async function denyAll() {
    if (!confirm('Deny all pending requests? This action will reject all pending join requests.')) return;
    
    try {
        const response = await fetch('/api/invite-requests/deny-all', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        const data = await response.json();
        showNotification(data.message, 'success');
        setTimeout(() => location.reload(), 1000);
    } catch (error) {
        showNotification('Error: ' + error, 'error');
    }
}
</script>
{% endblock %}
