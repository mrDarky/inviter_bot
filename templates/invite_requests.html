{% extends "base.html" %}

{% block title %}Invite Requests - Admin Panel{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-person-plus"></i> Invite Requests</h2>
</div>

<!-- Filter -->
<div class="card mb-3">
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-3">
                <label class="form-label">Status</label>
                <select class="form-select" name="status">
                    <option value="pending" {% if status == 'pending' %}selected{% endif %}>Pending</option>
                    <option value="approved" {% if status == 'approved' %}selected{% endif %}>Approved</option>
                    <option value="denied" {% if status == 'denied' %}selected{% endif %}>Denied</option>
                    <option value="" {% if status == '' or status is none %}selected{% endif %}>All</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Channel/Chat</label>
                <select class="form-select" name="chat_id">
                    <option value="">All Channels</option>
                    {% for chat in chat_ids %}
                    <option value="{{ chat.chat_id }}" {% if selected_chat_id == chat.chat_id %}selected{% endif %}>
                        Chat ID: {{ chat.chat_id }} ({{ chat.request_count }} requests)
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Date From</label>
                <input type="date" class="form-control" name="date_from" value="{{ date_from or '' }}">
            </div>
            <div class="col-md-2">
                <label class="form-label">Date To</label>
                <input type="date" class="form-control" name="date_to" value="{{ date_to or '' }}">
            </div>
            <div class="col-md-2">
                <label class="form-label">Skip Older N</label>
                <input type="number" class="form-control" name="older_than_count" 
                       value="{{ older_than_count or '' }}" 
                       placeholder="0" min="0"
                       title="Skip the first N oldest requests">
            </div>
            <div class="col-12">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-search"></i> Filter
                </button>
                <a href="/admin/invite-requests" class="btn btn-secondary">
                    <i class="bi bi-x-circle"></i> Clear Filters
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Actions Bar (Only for pending requests) -->
{% if status == 'pending' %}
<div class="card mb-3">
    <div class="card-body">
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-primary" onclick="selectAll()">
                <i class="bi bi-check-square"></i> Select All
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="deselectAll()">
                <i class="bi bi-square"></i> Deselect All
            </button>
        </div>
        <div class="btn-group ms-2" role="group">
            <button type="button" class="btn btn-success" onclick="approveSelected()">
                <i class="bi bi-check-circle"></i> Approve Selected
            </button>
            <button type="button" class="btn btn-danger" onclick="denySelected()">
                <i class="bi bi-x-circle"></i> Deny Selected
            </button>
        </div>
        <div class="btn-group ms-2" role="group">
            <button type="button" class="btn btn-success" onclick="approveAll()">
                <i class="bi bi-check-circle-fill"></i> Approve All
            </button>
            <button type="button" class="btn btn-danger" onclick="denyAll()">
                <i class="bi bi-x-circle-fill"></i> Deny All
            </button>
        </div>
    </div>
</div>
{% endif %}

<!-- Requests Table -->
<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        {% if status == 'pending' %}
                        <th width="50">
                            <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()">
                        </th>
                        {% endif %}
                        <th>User</th>
                        <th>Username</th>
                        <th>User ID</th>
                        <th>Chat ID</th>
                        <th>Request Date</th>
                        {% if status != 'pending' %}
                        <th>Processed Date</th>
                        {% endif %}
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for req in requests %}
                    <tr>
                        {% if status == 'pending' %}
                        <td>
                            <input type="checkbox" class="request-checkbox" value="{{ req.id }}">
                        </td>
                        {% endif %}
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="user-avatar me-2">
                                    {{ req.first_name[0] if req.first_name else 'U' }}
                                </div>
                                <div>
                                    <strong>{{ req.first_name or 'Unknown' }} {{ req.last_name or '' }}</strong>
                                </div>
                            </div>
                        </td>
                        <td>{{ '@' + req.username if req.username else '-' }}</td>
                        <td><code>{{ req.user_id }}</code></td>
                        <td><code>{{ req.chat_id }}</code></td>
                        <td>{{ req.request_date[:19].replace('T', ' ') if req.request_date else '-' }}</td>
                        {% if status != 'pending' %}
                        <td>{{ req.processed_date[:19].replace('T', ' ') if req.processed_date else '-' }}</td>
                        {% endif %}
                        <td>
                            {% if req.status == 'pending' %}
                            <span class="badge bg-warning">Pending</span>
                            {% elif req.status == 'approved' %}
                            <span class="badge bg-success">Approved</span>
                            {% elif req.status == 'denied' %}
                            <span class="badge bg-danger">Denied</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        {% if total_pages > 1 %}
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center">
                {% set filter_params = [] %}
                {% if status %}{% set _ = filter_params.append('status=' + status) %}{% endif %}
                {% if selected_chat_id %}{% set _ = filter_params.append('chat_id=' + selected_chat_id|string) %}{% endif %}
                {% if date_from %}{% set _ = filter_params.append('date_from=' + date_from) %}{% endif %}
                {% if date_to %}{% set _ = filter_params.append('date_to=' + date_to) %}{% endif %}
                {% if older_than_count %}{% set _ = filter_params.append('older_than_count=' + older_than_count|string) %}{% endif %}
                {% set filter_query = ('&' + '&'.join(filter_params)) if filter_params else '' %}
                
                {% if page > 1 %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page - 1 }}{{ filter_query }}">Previous</a>
                </li>
                {% endif %}
                
                {% for p in range(1, total_pages + 1) %}
                {% if p == page %}
                <li class="page-item active"><span class="page-link">{{ p }}</span></li>
                {% elif p <= 3 or p > total_pages - 3 or (p >= page - 1 and p <= page + 1) %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ p }}{{ filter_query }}">{{ p }}</a>
                </li>
                {% elif p == 4 or p == total_pages - 3 %}
                <li class="page-item disabled"><span class="page-link">...</span></li>
                {% endif %}
                {% endfor %}
                
                {% if page < total_pages %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page + 1 }}{{ filter_query }}">Next</a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Session selection modal state
let currentAction = null; // 'approve-selected', 'approve-all'
let selectedRequestIds = [];

function getSelectedRequestIds() {
    const checkboxes = document.querySelectorAll('.request-checkbox:checked');
    return Array.from(checkboxes).map(cb => parseInt(cb.value));
}

function selectAll() {
    document.querySelectorAll('.request-checkbox').forEach(cb => cb.checked = true);
    document.getElementById('selectAllCheckbox').checked = true;
}

function deselectAll() {
    document.querySelectorAll('.request-checkbox').forEach(cb => cb.checked = false);
    document.getElementById('selectAllCheckbox').checked = false;
}

function toggleSelectAll() {
    const checked = document.getElementById('selectAllCheckbox').checked;
    document.querySelectorAll('.request-checkbox').forEach(cb => cb.checked = checked);
}

// Load sessions and show modal
async function showSessionSelectionModal(action) {
    currentAction = action;
    
    if (action === 'approve-selected') {
        selectedRequestIds = getSelectedRequestIds();
        if (selectedRequestIds.length === 0) {
            showNotification('Please select at least one request', 'error');
            return;
        }
    }
    
    // Load sessions
    try {
        const response = await fetch('/api/sessions/list');
        
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({ message: 'Failed to load sessions' }));
            throw new Error(errorData.message || `HTTP error ${response.status}`);
        }
        
        const data = await response.json();
        
        const sessionSelect = document.getElementById('sessionSelect');
        sessionSelect.innerHTML = '<option value="">Bot (Default)</option>';
        
        if (data.sessions && data.sessions.length > 0) {
            data.sessions.forEach(session => {
                const option = document.createElement('option');
                option.value = session.session_name;
                option.textContent = `${session.user_info || session.session_name} (${session.session_type})`;
                sessionSelect.appendChild(option);
            });
        }
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('sessionSelectionModal'));
        modal.show();
    } catch (error) {
        showNotification('Error loading sessions: ' + error.message, 'error');
    }
}

// Execute approval with selected session
async function executeApproval() {
    const sessionSelect = document.getElementById('sessionSelect');
    const selectedSession = sessionSelect.value || null;
    
    const modal = bootstrap.Modal.getInstance(document.getElementById('sessionSelectionModal'));
    
    if (currentAction === 'approve-selected') {
        await performApproveSelected(selectedSession, modal);
    } else if (currentAction === 'approve-all') {
        await performApproveAll(selectedSession, modal);
    }
}

async function performApproveSelected(sessionName, modal) {
    if (selectedRequestIds.length === 0) {
        showNotification('Please select at least one request', 'error');
        return;
    }
    
    if (!confirm(`Approve ${selectedRequestIds.length} request(s)?`)) return;
    
    modal.hide();
    
    try {
        const response = await fetch('/api/invite-requests/approve', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                request_ids: selectedRequestIds,
                session_name: sessionName
            })
        });
        
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({ message: 'Request failed' }));
            throw new Error(errorData.message || `HTTP error ${response.status}`);
        }
        
        const data = await response.json();
        showNotification(data.message, 'success');
        setTimeout(() => location.reload(), 1000);
    } catch (error) {
        showNotification('Error: ' + error.message, 'error');
    }
}

async function performApproveAll(sessionName, modal) {
    if (!confirm('Approve all pending requests? This action will process all pending join requests.')) return;
    
    modal.hide();
    
    try {
        const response = await fetch('/api/invite-requests/approve-all', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                session_name: sessionName
            })
        });
        
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({ message: 'Request failed' }));
            throw new Error(errorData.message || `HTTP error ${response.status}`);
        }
        
        const data = await response.json();
        showNotification(data.message, 'success');
        setTimeout(() => location.reload(), 1000);
    } catch (error) {
        showNotification('Error: ' + error.message, 'error');
    }
}

// Updated button handlers
function approveSelected() {
    showSessionSelectionModal('approve-selected');
}

function approveAll() {
    showSessionSelectionModal('approve-all');
}

async function denySelected() {
    const requestIds = getSelectedRequestIds();
    if (requestIds.length === 0) {
        showNotification('Please select at least one request', 'error');
        return;
    }
    
    if (!confirm(`Deny ${requestIds.length} request(s)?`)) return;
    
    try {
        const response = await fetch('/api/invite-requests/deny', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(requestIds)
        });
        const data = await response.json();
        showNotification(data.message, 'success');
        setTimeout(() => location.reload(), 1000);
    } catch (error) {
        showNotification('Error: ' + error, 'error');
    }
}

async function denyAll() {
    if (!confirm('Deny all pending requests? This action will reject all pending join requests.')) return;
    
    try {
        const response = await fetch('/api/invite-requests/deny-all', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        const data = await response.json();
        showNotification(data.message, 'success');
        setTimeout(() => location.reload(), 1000);
    } catch (error) {
        showNotification('Error: ' + error, 'error');
    }
}
</script>

<!-- Session Selection Modal -->
<div class="modal fade" id="sessionSelectionModal" tabindex="-1" aria-labelledby="sessionSelectionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="sessionSelectionModalLabel">Select Session for Approval</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="sessionSelect" class="form-label">Session</label>
                    <select class="form-select" id="sessionSelect">
                        <option value="">Bot (Default)</option>
                    </select>
                    <div class="form-text">Select which session to use for approving requests. Default is the bot.</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="executeApproval()">
                    <i class="bi bi-check-circle"></i> Approve
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
