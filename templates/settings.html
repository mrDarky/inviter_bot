{% extends "base.html" %}

{% block title %}Settings - Admin Panel{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-gear"></i> Settings</h2>
</div>

<div class="row">
    <div class="col-md-8">
        <!-- Bot Token Configuration -->
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0">Bot Token Configuration</h5>
            </div>
            <div class="card-body">
                <form id="botTokenForm">
                    <div class="mb-3">
                        <label class="form-label">Bot Token</label>
                        <input type="password" class="form-control" id="botToken" name="bot_token" placeholder="Enter new bot token">
                        <small class="text-muted">
                            {% if settings.bot_token_masked %}
                                Current token: {{ settings.bot_token_masked }}
                            {% else %}
                                Using token from environment variables
                            {% endif %}
                        </small>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save"></i> Update Bot Token
                    </button>
                    <button type="button" class="btn btn-info" id="checkBotBtn">
                        <i class="bi bi-check-circle"></i> Check Bot
                    </button>
                </form>
                
                <!-- Bot Info Display -->
                {% if settings.bot_info %}
                <div class="mt-3 p-3 bg-light border rounded" id="botInfoDisplay">
                    <h6 class="mb-2"><i class="bi bi-robot"></i> Bot Information</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <p class="mb-1"><strong>Username:</strong> @{{ settings.bot_info.bot_username }}</p>
                            <p class="mb-1"><strong>Name:</strong> {{ settings.bot_info.bot_first_name }}</p>
                            <p class="mb-1"><strong>Bot ID:</strong> {{ settings.bot_info.bot_id }}</p>
                        </div>
                        <div class="col-md-6">
                            <p class="mb-1"><strong>Can Join Groups:</strong> 
                                {% if settings.bot_info.can_join_groups %}
                                    <span class="badge bg-success">Yes</span>
                                {% else %}
                                    <span class="badge bg-danger">No</span>
                                {% endif %}
                            </p>
                            <p class="mb-1"><strong>Can Read Messages:</strong> 
                                {% if settings.bot_info.can_read_all_group_messages %}
                                    <span class="badge bg-success">Yes</span>
                                {% else %}
                                    <span class="badge bg-danger">No</span>
                                {% endif %}
                            </p>
                            <p class="mb-1"><strong>Inline Queries:</strong> 
                                {% if settings.bot_info.supports_inline_queries %}
                                    <span class="badge bg-success">Yes</span>
                                {% else %}
                                    <span class="badge bg-secondary">No</span>
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="mt-3 p-3 bg-light border rounded" id="botInfoDisplay" style="display: none;">
                    <!-- Bot info will be displayed here after check -->
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Password Change -->
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0">Change Admin Password</h5>
            </div>
            <div class="card-body">
                <form id="passwordForm">
                    <div class="mb-3">
                        <label class="form-label">Old Password</label>
                        <input type="password" class="form-control" name="old_password" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">New Password</label>
                        <input type="password" class="form-control" name="new_password" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Confirm New Password</label>
                        <input type="password" class="form-control" name="confirm_password" id="confirmPassword" required>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-key"></i> Change Password
                    </button>
                </form>
            </div>
        </div>

        <!-- Bot Configuration -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Bot Configuration</h5>
            </div>
            <div class="card-body">
                <form id="settingsForm">
                    <div class="mb-3">
                        <label class="form-label">Welcome Message</label>
                        <textarea class="form-control" name="welcome_message" rows="3">{{ settings.welcome_message or 'Welcome to our channel!' }}</textarea>
                        <small class="text-muted">Message sent when users join a channel</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Bot Name</label>
                        <input type="text" class="form-control" name="bot_name" value="{{ settings.bot_name or 'Inviter Bot' }}">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Default API ID</label>
                        <input type="number" class="form-control" name="default_api_id" value="{{ settings.default_api_id or '' }}" placeholder="12345678" min="1">
                        <small class="text-muted">Default Telegram API ID for session manager (get from <a href="https://my.telegram.org" target="_blank">my.telegram.org</a>)</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Default API Hash</label>
                        <input type="text" class="form-control" name="default_api_hash" value="{{ settings.default_api_hash or '' }}" placeholder="abcdef1234567890" pattern="[a-fA-F0-9]{32}" minlength="32" maxlength="32">
                        <small class="text-muted">Default Telegram API Hash for session manager (get from <a href="https://my.telegram.org" target="_blank">my.telegram.org</a>)</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Daily Message Time</label>
                        <input type="time" class="form-control" name="daily_message_time" value="{{ settings.daily_message_time or '09:00' }}">
                        <small class="text-muted">Time to send daily static messages (24-hour format)</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Max Messages Per Day</label>
                        <input type="number" class="form-control" name="max_messages_per_day" value="{{ settings.max_messages_per_day or '10' }}" min="1">
                        <small class="text-muted">Maximum number of messages that can be sent per day to prevent spam</small>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" name="auto_ban_left_users" id="autoBan" {{ 'checked' if settings.auto_ban_left_users == 'true' else '' }}>
                        <label class="form-check-label" for="autoBan">
                            Auto-ban users who leave channels
                        </label>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" name="enable_welcome_message" id="enableWelcome" {{ 'checked' if settings.enable_welcome_message == 'true' or not settings.enable_welcome_message else '' }}>
                        <label class="form-check-label" for="enableWelcome">
                            Enable welcome messages
                        </label>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" name="enable_static_messages" id="enableStatic" {{ 'checked' if settings.enable_static_messages == 'true' or not settings.enable_static_messages else '' }}>
                        <label class="form-check-label" for="enableStatic">
                            Enable static messages
                        </label>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save"></i> Save Settings
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0">Information</h5>
            </div>
            <div class="card-body">
                <p><strong>Version:</strong> 1.0.0</p>
                <p><strong>Environment:</strong> Production</p>
                <p><strong>Database:</strong> SQLite</p>
                <hr>
                <p class="mb-0"><small class="text-muted">Inviter Bot Admin Panel</small></p>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header bg-warning">
                <h5 class="mb-0">Danger Zone</h5>
            </div>
            <div class="card-body">
                <p class="text-muted">These actions are irreversible</p>
                <button class="btn btn-outline-danger w-100 mb-2" onclick="clearStatistics()">
                    <i class="bi bi-trash"></i> Clear Statistics
                </button>
                <button class="btn btn-outline-danger w-100" onclick="exportData()">
                    <i class="bi bi-download"></i> Export Data
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Bot token form
document.getElementById('botTokenForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const botToken = formData.get('bot_token');
    
    if (!botToken) {
        showNotification('Please enter a bot token', 'error');
        return;
    }
    
    try {
        const response = await fetch('/api/settings/bot-token', {
            method: 'POST',
            body: formData
        });
        const data = await response.json();
        
        if (response.ok) {
            showNotification(data.message, 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification('Error: ' + (data.detail || data.message), 'error');
        }
    } catch (error) {
        showNotification('Error: ' + error, 'error');
    }
});

// Check Bot button handler
document.getElementById('checkBotBtn').addEventListener('click', async function(e) {
    e.preventDefault();
    
    const botToken = document.getElementById('botToken').value;
    const formData = new FormData();
    
    // Only include token if one was entered in the form
    if (botToken) {
        formData.append('bot_token', botToken);
    }
    
    // Disable button and show loading state
    const btn = e.target;
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Checking...';
    
    try {
        const response = await fetch('/api/settings/check-bot', {
            method: 'POST',
            body: formData
        });
        const data = await response.json();
        
        if (response.ok) {
            showNotification(data.message, 'success');
            
            // Display bot info
            const botInfo = data.bot_info;
            const botInfoDisplay = document.getElementById('botInfoDisplay');
            botInfoDisplay.style.display = 'block';
            botInfoDisplay.innerHTML = `
                <h6 class="mb-2"><i class="bi bi-robot"></i> Bot Information</h6>
                <div class="row">
                    <div class="col-md-6">
                        <p class="mb-1"><strong>Username:</strong> @${botInfo.bot_username}</p>
                        <p class="mb-1"><strong>Name:</strong> ${botInfo.bot_first_name}${botInfo.bot_last_name ? ' ' + botInfo.bot_last_name : ''}</p>
                        <p class="mb-1"><strong>Bot ID:</strong> ${botInfo.bot_id}</p>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-1"><strong>Can Join Groups:</strong> 
                            ${botInfo.can_join_groups ? '<span class="badge bg-success">Yes</span>' : '<span class="badge bg-danger">No</span>'}
                        </p>
                        <p class="mb-1"><strong>Can Read Messages:</strong> 
                            ${botInfo.can_read_all_group_messages ? '<span class="badge bg-success">Yes</span>' : '<span class="badge bg-danger">No</span>'}
                        </p>
                        <p class="mb-1"><strong>Inline Queries:</strong> 
                            ${botInfo.supports_inline_queries ? '<span class="badge bg-success">Yes</span>' : '<span class="badge bg-secondary">No</span>'}
                        </p>
                    </div>
                </div>
            `;
        } else {
            showNotification('Error: ' + (data.detail || data.message), 'error');
        }
    } catch (error) {
        showNotification('Error: ' + error, 'error');
    } finally {
        // Restore button state
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
});

// Password change form
document.getElementById('passwordForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const newPassword = formData.get('new_password');
    const confirmPassword = document.getElementById('confirmPassword').value;
    
    if (newPassword !== confirmPassword) {
        showNotification('New passwords do not match', 'error');
        return;
    }
    
    try {
        const response = await fetch('/api/settings/change-password', {
            method: 'POST',
            body: formData
        });
        const data = await response.json();
        
        if (response.ok) {
            showNotification(data.message, 'success');
            e.target.reset();
        } else {
            showNotification('Error: ' + (data.detail || data.message), 'error');
        }
    } catch (error) {
        showNotification('Error: ' + error, 'error');
    }
});

// Settings form
document.getElementById('settingsForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const settings = {};
    
    for (let [key, value] of formData.entries()) {
        settings[key] = value;
    }
    
    // Handle checkboxes
    settings.auto_ban_left_users = document.getElementById('autoBan').checked ? 'true' : 'false';
    settings.enable_welcome_message = document.getElementById('enableWelcome').checked ? 'true' : 'false';
    settings.enable_static_messages = document.getElementById('enableStatic').checked ? 'true' : 'false';
    
    try {
        const response = await fetch('/api/settings', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(settings)
        });
        const data = await response.json();
        showNotification(data.message, 'success');
    } catch (error) {
        showNotification('Error: ' + error, 'error');
    }
});

function clearStatistics() {
    if (!confirm('This will clear all statistics data. Are you sure?')) return;
    showNotification('This feature is not yet implemented', 'info');
}

function exportData() {
    showNotification('This feature is not yet implemented', 'info');
}
</script>
{% endblock %}
