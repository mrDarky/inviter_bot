{% extends "base.html" %}

{% block title %}Session Manager - Admin Panel{% endblock %}

{% block extra_css %}
<style>
    .session-card {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        background: #f8f9fa;
    }
    .session-card.active {
        border-color: #198754;
        background: #d1e7dd;
    }
    .session-card.inactive {
        border-color: #dc3545;
        background: #f8d7da;
    }
    .step-indicator {
        display: flex;
        justify-content: space-between;
        margin-bottom: 2rem;
    }
    .step {
        flex: 1;
        text-align: center;
        padding: 0.5rem;
        border-bottom: 3px solid #dee2e6;
        position: relative;
    }
    .step.active {
        border-color: #0d6efd;
        color: #0d6efd;
        font-weight: bold;
    }
    .step.completed {
        border-color: #198754;
        color: #198754;
    }
    .modal-lg {
        max-width: 900px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-person-badge"></i> Session Manager</h2>
        <div>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newSessionModal">
                <i class="bi bi-plus-circle"></i> Create New Session
            </button>
            <button class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#importSessionModal">
                <i class="bi bi-upload"></i> Import Session
            </button>
        </div>
    </div>

    <div class="alert alert-info">
        <i class="bi bi-info-circle"></i> <strong>Session Manager:</strong> This page allows you to manage Pyrogram user sessions for loading join requests from channels. You can create new sessions or import existing session files.
    </div>

    <!-- Sessions List -->
    <div id="sessionsList">
        {% if sessions %}
        {% for session in sessions %}
        <div class="session-card {% if session.is_active %}active{% else %}inactive{% endif %}">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h5><i class="bi bi-person-circle"></i> {{ session.session_name }}</h5>
                    <p class="mb-1"><strong>Phone:</strong> {{ session.phone_number }}</p>
                    {% if session.user_info %}
                    <p class="mb-1"><strong>User:</strong> {{ session.user_info }}</p>
                    {% endif %}
                    <small class="text-muted">Last check: {{ session.last_check or 'Never' }}</small>
                </div>
                <div class="col-md-6 text-end">
                    <button class="btn btn-sm btn-info" onclick="checkSession('{{ session.session_name }}')">
                        <i class="bi bi-check-circle"></i> Check Status
                    </button>
                    <button class="btn btn-sm btn-primary" onclick="openLoadRequestsModal('{{ session.session_name }}')">
                        <i class="bi bi-download"></i> Load Requests
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteSession('{{ session.session_name }}')">
                        <i class="bi bi-trash"></i> Delete
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
        {% else %}
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle"></i> No sessions found. Create a new session or import an existing one.
        </div>
        {% endif %}
    </div>
</div>

<!-- Create New Session Modal -->
<div class="modal fade" id="newSessionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Session</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Step Indicator -->
                <div class="step-indicator">
                    <div class="step active" id="step1">
                        <i class="bi bi-1-circle"></i> Credentials
                    </div>
                    <div class="step" id="step2">
                        <i class="bi bi-2-circle"></i> Phone Code
                    </div>
                    <div class="step" id="step3">
                        <i class="bi bi-3-circle"></i> 2FA / Password
                    </div>
                    <div class="step" id="step4">
                        <i class="bi bi-4-circle"></i> Complete
                    </div>
                </div>

                <!-- Step 1: Initial Credentials -->
                <div id="stepContent1" class="step-content">
                    <div class="mb-3">
                        <label class="form-label">Session Name</label>
                        <input type="text" class="form-control" id="sessionName" placeholder="my_session">
                        <small class="text-muted">Unique name for this session (no spaces)</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">API ID</label>
                        <input type="number" class="form-control" id="apiId" placeholder="12345678" value="{{ settings.default_api_id or '' }}">
                        <small class="text-muted">Get from <a href="https://my.telegram.org" target="_blank">my.telegram.org</a></small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">API Hash</label>
                        <input type="text" class="form-control" id="apiHash" placeholder="abcdef1234567890" value="{{ settings.default_api_hash or '' }}">
                        <small class="text-muted">Get from <a href="https://my.telegram.org" target="_blank">my.telegram.org</a></small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Phone Number</label>
                        <input type="text" class="form-control" id="phoneNumber" placeholder="+1234567890">
                        <small class="text-muted">Include country code</small>
                    </div>
                </div>

                <!-- Step 2: Phone Code -->
                <div id="stepContent2" class="step-content" style="display: none;">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> A verification code has been sent to your phone.
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Verification Code</label>
                        <input type="text" class="form-control" id="phoneCode" placeholder="12345">
                        <small class="text-muted">Enter the code sent to your phone</small>
                    </div>
                </div>

                <!-- Step 3: 2FA Password -->
                <div id="stepContent3" class="step-content" style="display: none;">
                    <div class="alert alert-warning">
                        <i class="bi bi-shield-lock"></i> Two-factor authentication is enabled for this account.
                    </div>
                    <div class="mb-3">
                        <label class="form-label">2FA Password</label>
                        <input type="password" class="form-control" id="password2FA" placeholder="Your 2FA password">
                        <small class="text-muted">Enter your cloud password</small>
                    </div>
                </div>

                <!-- Step 4: Complete -->
                <div id="stepContent4" class="step-content" style="display: none;">
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle"></i> <strong>Session created successfully!</strong>
                    </div>
                    <div id="userInfo"></div>
                </div>

                <div id="errorMessage" class="alert alert-danger" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="sendPhoneBtn" onclick="sendPhone()">
                    Send Phone
                </button>
                <button type="button" class="btn btn-primary" id="sendCodeBtn" onclick="sendCode()" style="display: none;">
                    Send Code
                </button>
                <button type="button" class="btn btn-primary" id="send2FABtn" onclick="send2FA()" style="display: none;">
                    Send Password
                </button>
                <button type="button" class="btn btn-success" id="completeBtn" onclick="completeSession()" style="display: none;">
                    Done
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Import Session Modal -->
<div class="modal fade" id="importSessionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Import Session File</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Session Name</label>
                    <input type="text" class="form-control" id="importSessionName" placeholder="my_session">
                    <small class="text-muted">Name for the imported session</small>
                </div>
                <div class="mb-3">
                    <label class="form-label">API ID</label>
                    <input type="number" class="form-control" id="importApiId" placeholder="12345678" value="{{ settings.default_api_id or '' }}">
                </div>
                <div class="mb-3">
                    <label class="form-label">API Hash</label>
                    <input type="text" class="form-control" id="importApiHash" placeholder="abcdef1234567890" value="{{ settings.default_api_hash or '' }}">
                </div>
                <div class="mb-3">
                    <label class="form-label">Phone Number</label>
                    <input type="text" class="form-control" id="importPhoneNumber" placeholder="+1234567890">
                </div>
                <div class="mb-3">
                    <label class="form-label">Session File (.session)</label>
                    <input type="file" class="form-control" id="sessionFile" accept=".session">
                    <small class="text-muted">Select the .session file to import</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="importSession()">Import</button>
            </div>
        </div>
    </div>
</div>

<!-- Load Requests Modal -->
<div class="modal fade" id="loadRequestsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Load Join Requests</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="loadSessionName">
                <div class="mb-3">
                    <label class="form-label">Channel ID or Username</label>
                    <input type="text" class="form-control" id="channelId" placeholder="@channelname or -1001234567890">
                    <small class="text-muted">Enter channel username (with @) or channel ID</small>
                </div>
                <div id="loadProgress" style="display: none;">
                    <div class="progress mb-3">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                    </div>
                    <p class="text-center">Loading requests...</p>
                </div>
                <div id="loadResult" class="alert" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="loadRequestsBtn" onclick="loadRequests()">
                    Load Requests
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentStep = 1;
let phoneCodeHash = '';

function updateStep(step) {
    currentStep = step;
    
    // Update step indicator
    for (let i = 1; i <= 4; i++) {
        const stepEl = document.getElementById('step' + i);
        const contentEl = document.getElementById('stepContent' + i);
        
        if (i < step) {
            stepEl.classList.add('completed');
            stepEl.classList.remove('active');
        } else if (i === step) {
            stepEl.classList.add('active');
            stepEl.classList.remove('completed');
        } else {
            stepEl.classList.remove('active', 'completed');
        }
        
        if (contentEl) {
            contentEl.style.display = i === step ? 'block' : 'none';
        }
    }
    
    // Update buttons
    document.getElementById('sendPhoneBtn').style.display = step === 1 ? 'inline-block' : 'none';
    document.getElementById('sendCodeBtn').style.display = step === 2 ? 'inline-block' : 'none';
    document.getElementById('send2FABtn').style.display = step === 3 ? 'inline-block' : 'none';
    document.getElementById('completeBtn').style.display = step === 4 ? 'inline-block' : 'none';
}

async function sendPhone() {
    const sessionName = document.getElementById('sessionName').value;
    const apiId = document.getElementById('apiId').value;
    const apiHash = document.getElementById('apiHash').value;
    const phoneNumber = document.getElementById('phoneNumber').value;
    
    if (!sessionName || !apiId || !apiHash || !phoneNumber) {
        showError('Please fill in all fields');
        return;
    }
    
    try {
        const response = await fetch('/api/pyrogram/send-code', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({session_name: sessionName, api_id: parseInt(apiId), api_hash: apiHash, phone_number: phoneNumber})
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            phoneCodeHash = data.phone_code_hash;
            updateStep(2);
            hideError();
        } else {
            showError(data.message || 'Failed to send code');
        }
    } catch (error) {
        showError('Error: ' + error.message);
    }
}

async function sendCode() {
    const phoneCode = document.getElementById('phoneCode').value;
    
    if (!phoneCode) {
        showError('Please enter the verification code');
        return;
    }
    
    try {
        const response = await fetch('/api/pyrogram/verify-code', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                session_name: document.getElementById('sessionName').value,
                phone_code: phoneCode,
                phone_code_hash: phoneCodeHash
            })
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            if (data.requires_password) {
                updateStep(3);
            } else {
                showUserInfo(data.user_info);
                updateStep(4);
            }
            hideError();
        } else {
            showError(data.message || 'Failed to verify code');
        }
    } catch (error) {
        showError('Error: ' + error.message);
    }
}

async function send2FA() {
    const password = document.getElementById('password2FA').value;
    
    if (!password) {
        showError('Please enter your 2FA password');
        return;
    }
    
    try {
        const response = await fetch('/api/pyrogram/verify-password', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                session_name: document.getElementById('sessionName').value,
                password: password
            })
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            showUserInfo(data.user_info);
            updateStep(4);
            hideError();
        } else {
            showError(data.message || 'Failed to verify password');
        }
    } catch (error) {
        showError('Error: ' + error.message);
    }
}

function showUserInfo(userInfo) {
    const userInfoEl = document.getElementById('userInfo');
    const info = JSON.parse(userInfo);
    userInfoEl.innerHTML = `
        <p><strong>User ID:</strong> ${info.id}</p>
        <p><strong>Username:</strong> @${info.username || 'N/A'}</p>
        <p><strong>Name:</strong> ${info.first_name} ${info.last_name || ''}</p>
        <p><strong>Phone:</strong> ${info.phone_number || 'N/A'}</p>
    `;
}

function completeSession() {
    location.reload();
}

async function importSession() {
    const sessionName = document.getElementById('importSessionName').value;
    const apiId = document.getElementById('importApiId').value;
    const apiHash = document.getElementById('importApiHash').value;
    const phoneNumber = document.getElementById('importPhoneNumber').value;
    const fileInput = document.getElementById('sessionFile');
    
    if (!sessionName || !apiId || !apiHash || !phoneNumber || !fileInput.files[0]) {
        showNotification('Please fill in all fields and select a session file', 'error');
        return;
    }
    
    const formData = new FormData();
    formData.append('session_name', sessionName);
    formData.append('api_id', apiId);
    formData.append('api_hash', apiHash);
    formData.append('phone_number', phoneNumber);
    formData.append('session_file', fileInput.files[0]);
    
    try {
        const response = await fetch('/api/pyrogram/import-session', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            showNotification('Session imported successfully!', 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showNotification(data.message || 'Failed to import session', 'error');
        }
    } catch (error) {
        showNotification('Error: ' + error.message, 'error');
    }
}

async function checkSession(sessionName) {
    try {
        const response = await fetch('/api/pyrogram/check-session', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({session_name: sessionName})
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            showNotification('Session is active: ' + data.user_info, 'success');
        } else {
            showNotification(data.message || 'Failed to check session', 'error');
        }
    } catch (error) {
        showNotification('Error: ' + error.message, 'error');
    }
}

function openLoadRequestsModal(sessionName) {
    document.getElementById('loadSessionName').value = sessionName;
    document.getElementById('channelId').value = '';
    document.getElementById('loadProgress').style.display = 'none';
    document.getElementById('loadResult').style.display = 'none';
    new bootstrap.Modal(document.getElementById('loadRequestsModal')).show();
}

async function loadRequests() {
    const sessionName = document.getElementById('loadSessionName').value;
    const channelId = document.getElementById('channelId').value;
    
    if (!channelId) {
        showNotification('Please enter a channel ID or username', 'error');
        return;
    }
    
    document.getElementById('loadRequestsBtn').disabled = true;
    document.getElementById('loadProgress').style.display = 'block';
    document.getElementById('loadResult').style.display = 'none';
    
    try {
        const response = await fetch('/api/pyrogram/load-requests', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({session_name: sessionName, channel_id: channelId})
        });
        
        const data = await response.json();
        
        document.getElementById('loadProgress').style.display = 'none';
        document.getElementById('loadRequestsBtn').disabled = false;
        
        const resultEl = document.getElementById('loadResult');
        resultEl.style.display = 'block';
        
        if (data.status === 'success') {
            resultEl.className = 'alert alert-success';
            resultEl.innerHTML = `<i class="bi bi-check-circle"></i> Successfully loaded ${data.count} join requests!`;
            showNotification(`Loaded ${data.count} join requests`, 'success');
        } else {
            resultEl.className = 'alert alert-danger';
            resultEl.innerHTML = `<i class="bi bi-x-circle"></i> ${data.message}`;
            showNotification(data.message || 'Failed to load requests', 'error');
        }
    } catch (error) {
        document.getElementById('loadProgress').style.display = 'none';
        document.getElementById('loadRequestsBtn').disabled = false;
        showNotification('Error: ' + error.message, 'error');
    }
}

async function deleteSession(sessionName) {
    if (!confirm('Are you sure you want to delete this session?')) {
        return;
    }
    
    try {
        const response = await fetch('/api/pyrogram/delete-session', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({session_name: sessionName})
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            showNotification('Session deleted successfully', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification(data.message || 'Failed to delete session', 'error');
        }
    } catch (error) {
        showNotification('Error: ' + error.message, 'error');
    }
}

function showError(message) {
    const errorEl = document.getElementById('errorMessage');
    errorEl.textContent = message;
    errorEl.style.display = 'block';
}

function hideError() {
    document.getElementById('errorMessage').style.display = 'none';
}
</script>
{% endblock %}
