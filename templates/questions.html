{% extends "base.html" %}

{% block title %}User Questions - Admin Panel{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-question-circle"></i> User Questions</h2>
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addQuestionModal">
        <i class="bi bi-plus-circle"></i> Add Question
    </button>
</div>

<div class="alert alert-info">
    <i class="bi bi-info-circle"></i> Configure questions to ask users during onboarding. Questions can be text input or button selection.
</div>

<!-- Questions Table -->
<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th width="50">Order</th>
                        <th>Question</th>
                        <th>Type</th>
                        <th>Required</th>
                        <th>Status</th>
                        <th width="200">Actions</th>
                    </tr>
                </thead>
                <tbody id="questionsTable">
                    {% if questions %}
                        {% for question in questions %}
                        <tr>
                            <td>{{ question.order_number }}</td>
                            <td>{{ question.question_text }}</td>
                            <td>
                                <span class="badge bg-info">{{ question.question_type }}</span>
                            </td>
                            <td>
                                {% if question.is_required %}
                                    <span class="badge bg-warning">Required</span>
                                {% else %}
                                    <span class="badge bg-secondary">Optional</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if question.is_active %}
                                    <span class="badge bg-success">Active</span>
                                {% else %}
                                    <span class="badge bg-secondary">Inactive</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="editQuestion({{ question.id }})">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-warning" onclick="toggleQuestion({{ question.id }})">
                                        <i class="bi bi-toggle-on"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteQuestion({{ question.id }})">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="6" class="text-center text-muted">
                                No questions configured. Click "Add Question" to get started.
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Question Modal -->
<div class="modal fade" id="addQuestionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Question</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addQuestionForm">
                    <div class="mb-3">
                        <label class="form-label">Question Text <span class="text-danger">*</span></label>
                        <textarea class="form-control" name="question_text" rows="2" required></textarea>
                        <small class="text-muted">The question to ask the user</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Question Type <span class="text-danger">*</span></label>
                        <select class="form-select" name="question_type" id="addQuestionType" required onchange="toggleOptions('add')">
                            <option value="text">Text Input</option>
                            <option value="buttons">Button Selection</option>
                        </select>
                        <small class="text-muted">How the user will answer</small>
                    </div>
                    
                    <div class="mb-3" id="addOptionsField" style="display: none;">
                        <label class="form-label">Answer Options</label>
                        <textarea class="form-control" name="options" rows="3"></textarea>
                        <small class="text-muted">Enter options separated by commas (e.g., Yes, No, Maybe) or as JSON array</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Order Number <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" name="order_number" value="0" min="0" required>
                        <small class="text-muted">Order in which this question appears (0 = first)</small>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" name="is_required" id="addIsRequired" checked>
                        <label class="form-check-label" for="addIsRequired">
                            Required Question
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitAddQuestion()">Add Question</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Question Modal -->
<div class="modal fade" id="editQuestionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Question</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editQuestionForm">
                    <input type="hidden" name="question_id" id="editQuestionId">
                    
                    <div class="mb-3">
                        <label class="form-label">Question Text <span class="text-danger">*</span></label>
                        <textarea class="form-control" name="question_text" id="editQuestionText" rows="2" required></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Question Type <span class="text-danger">*</span></label>
                        <select class="form-select" name="question_type" id="editQuestionType" required onchange="toggleOptions('edit')">
                            <option value="text">Text Input</option>
                            <option value="buttons">Button Selection</option>
                        </select>
                    </div>
                    
                    <div class="mb-3" id="editOptionsField" style="display: none;">
                        <label class="form-label">Answer Options</label>
                        <textarea class="form-control" name="options" id="editOptions" rows="3"></textarea>
                        <small class="text-muted">Enter options separated by commas or as JSON array</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Order Number <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" name="order_number" id="editOrderNumber" min="0" required>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" name="is_required" id="editIsRequired">
                        <label class="form-check-label" for="editIsRequired">
                            Required Question
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitEditQuestion()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
function toggleOptions(type) {
    const questionType = document.getElementById(`${type}QuestionType`).value;
    const optionsField = document.getElementById(`${type}OptionsField`);
    
    if (questionType === 'buttons') {
        optionsField.style.display = 'block';
    } else {
        optionsField.style.display = 'none';
    }
}

async function submitAddQuestion() {
    const form = document.getElementById('addQuestionForm');
    const formData = new FormData(form);
    
    // Validate order number
    const orderNumber = parseInt(formData.get('order_number'));
    if (isNaN(orderNumber) || orderNumber < 0) {
        showNotification('Order number must be a non-negative integer', 'error');
        return;
    }
    
    const data = {
        question_text: formData.get('question_text'),
        question_type: formData.get('question_type'),
        options: formData.get('options') || null,
        order_number: orderNumber,
        is_required: document.getElementById('addIsRequired').checked ? 1 : 0
    };
    
    try {
        const response = await fetch('/api/questions/add', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showNotification(result.message, 'success');
            bootstrap.Modal.getInstance(document.getElementById('addQuestionModal')).hide();
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification('Error: ' + (result.detail || result.message), 'error');
        }
    } catch (error) {
        showNotification('Error: ' + error, 'error');
    }
}

async function editQuestion(questionId) {
    try {
        const response = await fetch(`/api/questions/${questionId}`);
        const question = await response.json();
        
        if (response.ok) {
            document.getElementById('editQuestionId').value = question.id;
            document.getElementById('editQuestionText').value = question.question_text;
            document.getElementById('editQuestionType').value = question.question_type;
            document.getElementById('editOptions').value = question.options || '';
            document.getElementById('editOrderNumber').value = question.order_number;
            document.getElementById('editIsRequired').checked = question.is_required === 1;
            
            toggleOptions('edit');
            
            const modal = new bootstrap.Modal(document.getElementById('editQuestionModal'));
            modal.show();
        } else {
            showNotification('Error loading question', 'error');
        }
    } catch (error) {
        showNotification('Error: ' + error, 'error');
    }
}

async function submitEditQuestion() {
    const form = document.getElementById('editQuestionForm');
    const formData = new FormData(form);
    const questionId = formData.get('question_id');
    
    // Validate order number
    const orderNumber = parseInt(formData.get('order_number'));
    if (isNaN(orderNumber) || orderNumber < 0) {
        showNotification('Order number must be a non-negative integer', 'error');
        return;
    }
    
    const data = {
        question_text: formData.get('question_text'),
        question_type: formData.get('question_type'),
        options: formData.get('options') || null,
        order_number: orderNumber,
        is_required: document.getElementById('editIsRequired').checked ? 1 : 0
    };
    
    try {
        const response = await fetch(`/api/questions/${questionId}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showNotification(result.message, 'success');
            bootstrap.Modal.getInstance(document.getElementById('editQuestionModal')).hide();
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification('Error: ' + (result.detail || result.message), 'error');
        }
    } catch (error) {
        showNotification('Error: ' + error, 'error');
    }
}

async function toggleQuestion(questionId) {
    if (!confirm('Toggle question active status?')) return;
    
    try {
        const response = await fetch(`/api/questions/${questionId}/toggle`, {
            method: 'POST'
        });
        const result = await response.json();
        
        if (response.ok) {
            showNotification(result.message, 'success');
            setTimeout(() => location.reload(), 500);
        } else {
            showNotification('Error: ' + (result.detail || result.message), 'error');
        }
    } catch (error) {
        showNotification('Error: ' + error, 'error');
    }
}

async function deleteQuestion(questionId) {
    if (!confirm('Are you sure you want to delete this question? This will also delete all user answers to this question.')) return;
    
    try {
        const response = await fetch(`/api/questions/${questionId}`, {
            method: 'DELETE'
        });
        const result = await response.json();
        
        if (response.ok) {
            showNotification(result.message, 'success');
            setTimeout(() => location.reload(), 500);
        } else {
            showNotification('Error: ' + (result.detail || result.message), 'error');
        }
    } catch (error) {
        showNotification('Error: ' + error, 'error');
    }
}
</script>
{% endblock %}
